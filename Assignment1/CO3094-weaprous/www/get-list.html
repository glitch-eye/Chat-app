<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Peer List</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
        }
        table { 
            width: 80%; 
            border-collapse: collapse; 
            margin-top: 20px; 
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
        }
        th { 
            background-color: #f2f2f2; 
        }
        /* Style cho các nút bấm/liên kết */
        .action-button {
            padding: 10px 15px;
            margin-right: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none; /* Dùng cho thẻ <a> */
            display: inline-block;
            text-align: center;
        }
        .reload-button {
            background-color: #007bff;
            color: white;
        }
        .home-button {
            background-color: #6c757d;
            color: white;
        }
        .action-button:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <h1>Danh sách Peers đang hoạt động</h1>
    
    <div style="margin-bottom: 20px;">
        <button onclick="fetchPeerList()" class="action-button reload-button">Tải lại danh sách</button>
        
        <a href="/" class="action-button home-button">Quay về Trang chủ</a>
    </div>

    <table id="peer-table">
        <thead>
            <tr>
                <th>Username</th>
                <th>IP Address</th>
                <th>P2P Port</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
    
    <p id="status-message"></p>

    <script>
        function fetchPeerList() {
            const tbody = document.getElementById('peer-table').getElementsByTagName('tbody')[0];
            const statusMsg = document.getElementById('status-message');
            tbody.innerHTML = ''; // Xóa dữ liệu cũ
            statusMsg.textContent = 'Đang tải...';

            // 1. Gửi Request GET đến API /list/
            fetch('/list/')
                .then(response => {
                    if (response.status === 401) {
                        // Nếu chưa xác thực, chuyển hướng về trang đăng nhập
                        window.location.href = '/login.html'; 
                        return null;
                    }
                    if (!response.ok) {
                        throw new Error('Lỗi mạng hoặc Server');
                    }
                    return response.json(); // Phân tích JSON Response
                })
                .then(data => {
                    if (!data) return; 
                    
                    statusMsg.textContent = `Tìm thấy ${data.length} Peer.`;
                    
                    // 2. Lặp qua dữ liệu và chèn vào bảng
                    data.forEach(peer => {
                        const row = tbody.insertRow();
                        
                        // *Giả định* API trả về JSON Object:
                        row.insertCell().textContent = peer.username; 
                        row.insertCell().textContent = peer.ip;
                        row.insertCell().textContent = peer.p2p_port;
                        row.insertCell().textContent = peer.status;
                        
                    });
                })
                .catch(error => {
                    console.error('Lỗi khi tải Peer List:', error);
                    statusMsg.textContent = `Lỗi: Không thể kết nối hoặc Server không phản hồi. (${error.message})`;
                });
        }

        // Tải danh sách ngay khi trang được load
        document.addEventListener('DOMContentLoaded', fetchPeerList);
    </script>
</body>
</html>