<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat P2P</title>
    <style>
        /* --- CSS CHO GIAO DI·ªÜN CHAT --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f4f7f9;
        }
        #chat-header {
            padding: 15px;
            background-color: #007bff;
            color: white;
            font-size: 1.2em;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #message-window {
            flex-grow: 1; /* Chi·∫øm h·∫øt kh√¥ng gian c√≤n l·∫°i */
            padding: 15px;
            overflow-y: auto; /* üéØ Y√äU C·∫¶U 1: C·ª≠a s·ªï cu·ªôn */
            background-color: white;
        }
        .message {
            margin-bottom: 10px;
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 18px;
            line-height: 1.4;
            word-wrap: break-word; /* ƒê·∫£m b·∫£o tin nh·∫Øn d√†i kh√¥ng tr√†n */
        }
        .message.sent { /* Tin nh·∫Øn c·ªßa m√¨nh (G·ª≠i ƒëi) */
            align-self: flex-end;
            margin-left: auto;
            background-color: #007bff;
            color: white;
            border-bottom-right-radius: 2px;
        }
        .message.received { /* Tin nh·∫Øn c·ªßa ƒë·ªëi t√°c (Nh·∫≠n v√†o) */
            align-self: flex-start;
            margin-right: auto;
            background-color: #e0e0e0;
            color: #333;
            border-bottom-left-radius: 2px;
        }
        .message-author {
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 2px;
            display: block;
        }
        #message-input-area {
            padding: 10px 15px;
            background-color: #fff;
            border-top: 1px solid #ccc;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
        }
        #message-form {
            display: flex;
        }
        #message-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 1em;
            outline: none;
        }
        #send-button {
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        #send-button:hover {
            background-color: #218838;
        }
        /* üéØ Th√™m style cho Notification t·∫°m th·ªùi */
        .notification-badge {
            color: #dc3545;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div id="chat-header">
        ƒêang Chat v·ªõi <span id="peer-name">[T√™n Peer]</span> 
        <span id="notification-badge" class="notification-badge" style="display:none;">(Tin nh·∫Øn m·ªõi!)</span>
    </div>

    <div id="message-window">
        </div>

    <div id="message-input-area">
        <form id="message-form">
            <input type="text" id="message-input" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off" required>
            <button type="submit" id="send-button">G·ª≠i</button>
        </form>
    </div>

    <script>
        // L·∫•y username c·ªßa Peer ƒëang chat t·ª´ URL query string
        const urlParams = new URLSearchParams(window.location.search);
        const targetUsername = urlParams.get('peer_username');
        let myUsername = '[T√¥i]'; // üí° S·∫Ω c·∫ßn l·∫•y t·ª´ Backend Python

        document.getElementById('peer-name').textContent = targetUsername || 'ƒê·ªëi t√°c kh√¥ng x√°c ƒë·ªãnh';

        // --- H√ÄM TI·ªÜN √çCH ---

        function appendMessageToUI(message) {
            // message: { author: 'Alice', content: 'Hi Bob', timestamp: '...' }
            const msgDiv = document.createElement('div');
            const isSent = message.author === myUsername;
            
            msgDiv.className = 'message ' + (isSent ? 'sent' : 'received');
            
            // üéØ Y√äU C·∫¶U: Hi·ªÉn th·ªã tin nh·∫Øn (immutable) üéØ
            msgDiv.innerHTML = `
                <span class="message-author">${isSent ? 'B·∫°n' : message.author}</span>
                ${message.content}
            `;
            
            document.getElementById('message-window').appendChild(msgDiv);
        }

        function scrollToBottom() {
            const window = document.getElementById('message-window');
            window.scrollTop = window.scrollHeight;
        }

        // --- üéØ LOGIC G·ª¨I TIN NH·∫ÆN (HTTP POST C·ª§C B·ªò) üéØ ---
        document.getElementById('message-form').addEventListener('submit', function(e) {
            e.preventDefault(); 
            const inputField = document.getElementById('message-input');
            const content = inputField.value.trim();

            if (!content) return;

            // 1. G·ª≠i HTTP Request ƒë·∫øn Backend Python C·ª§C B·ªò
            fetch('/send-message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    to: targetUsername, // T√™n Peer ƒë√≠ch
                    content: content 
                })
            })
            .then(response => {
                if (response.ok) {
                    // T·∫°m th·ªùi hi·ªÉn th·ªã tin nh·∫Øn c·ªßa m√¨nh ngay l·∫≠p t·ª©c (Responsive UI)
                    appendMessageToUI({ author: myUsername, content: content });
                    scrollToBottom();
                    inputField.value = ''; // X√≥a input
                } else {
                    alert('L·ªói: Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn qua Backend.');
                }
            })
            .catch(error => {
                console.error('Error sending message:', error);
                alert('L·ªói k·∫øt n·ªëi Backend c·ª•c b·ªô.');
            });
        });

        // --- üéØ LOGIC NH·∫¨N TIN NH·∫ÆN (POLLING) üéØ ---
        function pollNewMessages() {
            // L·∫Øng nghe tin nh·∫Øn m·ªõi t·ª´ Peer ƒëang chat
            fetch(`/get-messages?peer=${targetUsername}`)
                .then(res => {
                    if (res.status === 200) return res.json();
                    throw new Error('L·ªói Polling');
                })
                .then(newMessages => {
                    let receivedNew = false;
                    newMessages.forEach(msg => {
                        appendMessageToUI(msg);
                        receivedNew = true;
                    });
                    
                    if (receivedNew) {
                        scrollToBottom();
                        // üéØ Y√äU C·∫¶U 4: H·ªá th·ªëng th√¥ng b√°o üéØ
                        // T·∫°m th·ªùi thay ƒë·ªïi ti√™u ƒë·ªÅ tr√¨nh duy·ªát
                        document.title = `(${newMessages.length}) Tin nh·∫Øn m·ªõi t·ª´ ${targetUsername}`;
                        document.getElementById('notification-badge').style.display = 'inline';
                    }
                })
                .catch(error => {
                    console.error("Polling error:", error);
                });
        }
        
        // B·∫Øt ƒë·∫ßu Polling sau 1 gi√¢y
        setInterval(pollNewMessages, 1000); 

        // ƒê·∫∑t l·∫°i ti√™u ƒë·ªÅ khi c·ª≠a s·ªï ƒë∆∞·ª£c focus
        window.onfocus = function() {
            document.title = `Chat P2P v·ªõi ${targetUsername}`;
            document.getElementById('notification-badge').style.display = 'none';
        };

        // Kh·ªüi t·∫°o (C·∫ßn l·∫•y username c·ªßa m√¨nh sau khi Backend ho·∫°t ƒë·ªông)
        // ƒê√¢y l√† b∆∞·ªõc quan tr·ªçng: Backend c·∫ßn cung c·∫•p username c·ªßa Peer hi·ªán t·∫°i!
        // Gi·∫£ s·ª≠ c√≥ m·ªôt API /my-info/
        fetch('/my-info')
            .then(res => res.json())
            .then(data => {
                myUsername = data.username;
            })
            .catch(() => {
                console.warn("Could not fetch local username. Using default.");
            });
    </script>
</body>
</html>